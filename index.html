<!-- HTML (ä¿æŒä¸è®Š) -->

<script>
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const resultDiv = document.getElementById('result');

fileInput.addEventListener('change', async () => {
  const file = fileInput.files[0];
  if (!file) return;

  // é è¦½åœ–ç‰‡
  const reader = new FileReader();
  reader.onload = () => {
    preview.src = reader.result;
  };
  reader.readAsDataURL(file);

  resultDiv.innerHTML = 'è¾¨è­˜ä¸­ï¼Œè«‹ç¨å€™... <span class="loader"></span>';

  const formData = new FormData();

  // âš ï¸ ç¸®å°åœ–ç‰‡å°ºå¯¸å¾Œå†é€å‡ºï¼ˆé¿å…ä¸Šå‚³å¤ªå¤§ï¼‰
  const resizedImageBlob = await resizeImage(file, 400, 400);
  formData.append('image', resizedImageBlob, file.name);

  try {
    const response = await fetch('https://fitness-pose-api.onrender.com/predict', {
      method: 'POST',
      body: formData,
    });

    const result = await response.json();

    if (result.class_name) {
      resultDiv.textContent = `çµæœï¼š${result.class_name}ï¼ˆä¿¡å¿ƒå€¼ ${Math.round(result.confidence * 100)}%ï¼‰`;
    } else {
      resultDiv.textContent = `âŒ éŒ¯èª¤ï¼š${result.error || 'æœªçŸ¥éŒ¯èª¤'}`;
    }
  } catch (err) {
    console.error("Fetch éŒ¯èª¤ï¼š", err);
    resultDiv.textContent = `âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š${err.message}`;
  }
});

// ğŸ”§ å£“ç¸®åœ–ç‰‡
async function resizeImage(file, maxWidth, maxHeight) {
  const img = await createImageBitmap(file);
  const canvas = document.createElement('canvas');

  let scale = Math.min(maxWidth / img.width, maxHeight / img.height);
  canvas.width = img.width * scale;
  canvas.height = img.height * scale;

  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  return new Promise((resolve) => {
    canvas.toBlob((blob) => {
      resolve(blob);
    }, 'image/jpeg', 0.8);
  });
}
</script>
