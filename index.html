<!-- ✅ HTML 主體 -->
<input type="file" id="fileInput" accept="image/*">
<br>
<img id="preview" style="max-width: 300px; display: block; margin-top: 10px;">
<div id="result" style="margin-top: 10px; font-weight: bold;"></div>

<!-- ✅ JavaScript -->
<script>
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const resultDiv = document.getElementById('result');

// 當使用者選擇圖片
fileInput.addEventListener('change', async () => {
  const file = fileInput.files[0];

  if (!file) return;
  if (!file.type.startsWith('image/')) {
    resultDiv.textContent = '⚠️ 請選擇圖片檔案！';
    return;
  }

  // 預覽圖片
  const reader = new FileReader();
  reader.onload = () => {
    preview.src = reader.result;
  };
  reader.readAsDataURL(file);

  resultDiv.innerHTML = '辨識中，請稍候... <span class="loader"></span>';

  try {
    const formData = new FormData();

    // ✅ 壓縮圖片（最大寬高 400px，品質 80%）
    const resizedImageBlob = await resizeImage(file, 400, 400);
    formData.append('image', resizedImageBlob, file.name);

    const response = await fetch('https://fitness-pose-api.onrender.com/predict', {
      method: 'POST',
      body: formData,
    });

    const result = await response.json();

    if (result.class_name) {
      resultDiv.textContent = `✅ 結果：${result.class_name}（信心值 ${Math.round(result.confidence * 100)}%）`;
    } else {
      resultDiv.textContent = `❌ 錯誤：${result.error || '未知錯誤'}`;
    }
  } catch (err) {
    console.error("❌ 錯誤：", err);
    resultDiv.textContent = `⚠️ 發生錯誤：${err.message || '連線失敗'}`;
  }
});

// ✅ 圖片縮小工具（輸出 JPEG）
async function resizeImage(file, maxWidth, maxHeight) {
  const img = await createImageBitmap(file);
  const canvas = document.createElement('canvas');

  const scale = Math.min(maxWidth / img.width, maxHeight / img.height, 1);
  canvas.width = img.width * scale;
  canvas.height = img.height * scale;

  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  return new Promise((resolve) => {
    canvas.toBlob((blob) => {
      resolve(blob);
    }, 'image/jpeg', 0.8); // 壓縮品質 80%
  });
}
</script>
