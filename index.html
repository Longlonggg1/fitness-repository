<!-- HTML (保持不變) -->

<script>
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const resultDiv = document.getElementById('result');

fileInput.addEventListener('change', async () => {
  const file = fileInput.files[0];
  if (!file) return;

  // 預覽圖片
  const reader = new FileReader();
  reader.onload = () => {
    preview.src = reader.result;
  };
  reader.readAsDataURL(file);

  resultDiv.innerHTML = '辨識中，請稍候... <span class="loader"></span>';

  const formData = new FormData();

  // ⚠️ 縮小圖片尺寸後再送出（避免上傳太大）
  const resizedImageBlob = await resizeImage(file, 400, 400);
  formData.append('image', resizedImageBlob, file.name);

  try {
    const response = await fetch('https://fitness-pose-api.onrender.com/predict', {
      method: 'POST',
      body: formData,
    });

    const result = await response.json();

    if (result.class_name) {
      resultDiv.textContent = `結果：${result.class_name}（信心值 ${Math.round(result.confidence * 100)}%）`;
    } else {
      resultDiv.textContent = `❌ 錯誤：${result.error || '未知錯誤'}`;
    }
  } catch (err) {
    console.error("Fetch 錯誤：", err);
    resultDiv.textContent = `⚠️ 發生錯誤：${err.message}`;
  }
});

// 🔧 壓縮圖片
async function resizeImage(file, maxWidth, maxHeight) {
  const img = await createImageBitmap(file);
  const canvas = document.createElement('canvas');

  let scale = Math.min(maxWidth / img.width, maxHeight / img.height);
  canvas.width = img.width * scale;
  canvas.height = img.height * scale;

  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

  return new Promise((resolve) => {
    canvas.toBlob((blob) => {
      resolve(blob);
    }, 'image/jpeg', 0.8);
  });
}
</script>
